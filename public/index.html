<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Code Collabe</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">

  <script>
    window.MONACO_BASE_URL = "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.47.0/min";
  </script>
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
  <script src="https://kit.fontawesome.com/4edb3588d0.js" crossorigin="anonymous"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.47.0/min/vs/editor/editor.main.min.css">

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style2.css">
</head>
<body data-room="">
  <nav class="navbar">
    <ul class="navbar-links">
      <li><a href="/">Home</a></li>
      <li><a href="/profile">Profile</a></li>
      <li><a href="/dashboard">Dashboard</a></li>
      <li><a href="/auth/logout">Logout</a></li>
    </ul>
    <div class="navbar-brand">Code Collabe</div>
  </nav>
  <!-- Mobile top bar (visible only on small screens) -->
  <div class="mobile-top-bar">
    <button class="mobile-back-btn" onclick="history.back()" title="Back">‚Äπ</button>
    <div class="mobile-room-display" id="mobileRoomDisplay">Room ID: #loading...</div>
    <button class="mobile-options-btn" title="Options">‚ãÆ</button>
  </div>
  <div class="workspace">
    <aside class="panel panel-left" id="panelLeft">
      <div class="collapse-handle" id="collapseLeft" title="Collapse">‚óÄ</div>
      <div class="panel-header">
        <span>Files</span>
        <small class="panel-subtitle">shared explorer</small>
      </div>
      <!-- Static file toolbar: search/newfile row and separate upload row (column layout) -->
      <div id="fileToolbar" class="file-toolbar" style="display:flex;flex-direction:column;gap:8px;padding:8px; margin-bottom:6px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <div style="flex:1;position:relative;display:flex;align-items:center;">
            <span style="position:absolute;left:8px;opacity:0.7;font-size:14px;pointer-events:none;">üîç</span>
            <input id="fileSearchInput" type="text" placeholder="Search files..." style="width:100%;padding:8px 10px 8px 34px;background:#ffffff11;border:1px solid #ffffff15;color:#fff;border-radius:6px;font-size:13px;outline:none;">
          </div>
            <button id="newFileBtnToolbar" title="New File" aria-label="New file" style="background:#0a5;color:#fff;border:none;padding:8px 12px;font-weight:bold;border-radius:6px;font-size:16px;cursor:pointer;"><i class="fa-solid fa-plus"></i></button>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <input id="fileUploadInput" type="file" title="Upload file from your machine" style="display: none;">
          <button id="uploadFileBtn" type="button" title="Upload selected file" aria-label="Upload file" style="background:transparent;border:1px solid #ffffff22;color:#fff;padding:8px 12px;border-radius:6px;cursor:pointer;"><i class="fa-solid fa-upload"></i></button>
        </div>
      </div>
      <div class="collapsed-icons" data-panel="left" aria-hidden="true">
        <button type="button" class="collapsed-icon" title="Open files" data-action="open-files">
          <span aria-hidden="true">üìÅ</span>
        </button>
        <button type="button" class="collapsed-icon" title="Search files" data-action="search-files">
          <span aria-hidden="true">üîç</span>
        </button>
        <button type="button" class="collapsed-icon" title="New file" data-action="new-file">
          <span aria-hidden="true"><i class="fa-solid fa-upload"></i></span>
        </button>
      </div>
      <div id="fileList" class="file-list"></div>
    </aside>

    <div class="resizer resizer-left" id="resizerLeft" title="Drag to resize"></div>
    <section class="panel panel-center" id="panelCenter">
      <div class="menu">
        <select id="language" title="Select Judge0 language">
          <option value="63" data-monaco="javascript">JavaScript</option>
          <option value="71" data-monaco="python">Python</option>
          <option value="54" data-monaco="cpp">CPP</option>
          <option value="62" data-monaco="java">Java</option>
          <option value="68" data-monaco="php">PHP</option>
          <option value="82" data-monaco="sql">SQL</option>
          <option value="22" data-monaco="go">Go</option>
          <option value="80" data-monaco="r">R</option>
          <option value="73" data-monaco="rust">Rust</option>
          <option value="50" data-monaco="c">C</option>
          <option value="72" data-monaco="ruby">Ruby</option>
          <option value="51" data-monaco="csharp">CSharp</option>
          <option value="78" data-monaco="kotlin">Kotlin</option>
          <option value="74" data-monaco="typescript">TypeScript</option>
        </select>
        <div class="room-controls menu-item">
          <input type="text" id="roomInput" placeholder="Enter Room ID">
          <button id="JoinRoomButton" type="button">Join</button>
          <button id="RoomButton" type="button">New Room</button>
        </div>
        <div class="empty-div"></div>
        <div class="menu-item">
          <button id="runButton" type="button" title="Run code" aria-label="Run code"><i class="fa-solid fa-play"></i></button>
          <button id="saveButton" type="button" title="Save file" aria-label="Save file"><i class="fa-solid fa-floppy-disk"></i></button>
          <button id="whiteboardBtn" type="button" title="Open Whiteboard" aria-label="Open whiteboard"><i class="fa-solid fa-chalkboard"></i></button>
        </div>
      </div>
      <div class="editor-whiteboard-wrapper" id="editorWhiteboardWrapper">
        <div class="editor-shell">
          <div id="editor-container">
            <button id="themeToggleBtn" title="Toggle Light/Dark Theme">
              <span id="themeToggleIcon" aria-label="theme">üåô</span>
            </button>
            <div id="ai-hint" class="ai-hint-badge" title="AI Assistant - Click for shortcuts">
              <span class="ai-hint-icon">ü§ñ</span>
              <div class="ai-hint-content">
                <div class="ai-hint-title">AI Assistant</div>
                <div class="ai-hint-keys">
                  <kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>Space</kbd>
                </div>
                <div class="ai-hint-accept">
                  Accept: <kbd>Tab</kbd>
                </div>
              </div>
            </div>
            <div id="editor"></div>
          </div>
          <!-- Output resizer and console panel placed inside editor-shell so output sits below editor -->
          <div class="resizer resizer-horizontal" id="resizerOutput" title="Drag to resize output" aria-label="Resize Output"></div>
          <section class="panel-output panel" id="panelOutput" aria-label="Output Panel">
            <div class="panel-output-heading">
              <div class="panel-header">
                <span>Console</span>
                <small class="panel-subtitle">Run Input / Output</small>
              </div>
              <div class="output-tabs" role="tablist" aria-label="Console sections">
                <button type="button" class="output-tab active" id="outputTab" role="tab" data-target="outputSection" aria-selected="true">Output</button>
                <button type="button" class="output-tab" id="stdinTab" role="tab" data-target="stdinSection" aria-selected="false">StdIn</button>
                <button type="button" class="output-tab" id="errorsTab" role="tab" data-target="errorsSection" aria-selected="false">Errors</button>
              </div>
            </div>
            <div class="output-sections">
              <div class="output-section active" id="outputSection" role="tabpanel" aria-labelledby="outputTab">
                <div class="output-wrapper">
                  <pre id="output"></pre>
                  <button id="clearOutputBtn" title="Clear output" class="clear-output-btn">&#128465;</button>
                </div>
              </div>
              <div class="output-section" id="stdinSection" role="tabpanel" aria-labelledby="stdinTab" aria-hidden="true">
                <label for="stdinInput" class="stdin-label">Standard Input</label>
                <textarea id="stdinInput" placeholder="Type stdin that will be piped into your program..."></textarea>
                <p class="stdin-hint">This input is sent with every Run request.</p>
              </div>
              <div class="output-section" id="errorsSection" role="tabpanel" aria-labelledby="errorsTab" aria-hidden="true">
                <div class="errors-wrapper">
                  <pre id="stderrOutput">No stderr output yet.</pre>
                </div>
              </div>
            </div>
          </section>
        </div>
        <div class="resizer resizer-inline" id="inlineResizer" title="Drag to resize whiteboard" aria-hidden="true"></div>
        <div class="whiteboard-panel collapsed" id="inlineWhiteboardPanel" aria-hidden="true" data-width="420">
          <div class="whiteboard-panel-header">
            <div>
              <span class="whiteboard-title">Whiteboard</span>
              <span class="whiteboard-room">Room <span id="whiteboardRoomLabel">loading...</span></span>
            </div>
            <div class="whiteboard-panel-controls">
              <button id="whiteboardDetachBtn" type="button" class="whiteboard-action" title="Open in new tab" aria-label="Detach whiteboard">
                <i class="fa-solid fa-up-right-from-square"></i>
              </button>
              <button id="whiteboardMinimizeBtn" type="button" class="whiteboard-action" title="Hide whiteboard" aria-label="Hide whiteboard">
                <i class="fa-solid fa-chevron-right"></i>
              </button>
            </div>
          </div>
          <div class="inline-wb-toolbar" role="toolbar" aria-label="Whiteboard tools">
            <div class="tool-group">
              <button type="button" class="tool-btn active" data-tool="pen" aria-pressed="true" title="Pen (P)">
                <span>Pen</span>
              </button>
              <button type="button" class="tool-btn" data-tool="eraser" aria-pressed="false" title="Eraser (E)">
                <span>Eraser</span>
              </button>
              <button type="button" class="tool-btn" data-tool="line" aria-pressed="false" title="Line (L)">
                <span>Line</span>
              </button>
              <button type="button" class="tool-btn" data-tool="rect" aria-pressed="false" title="Rectangle (R)">
                <span>Rect</span>
              </button>
              <button type="button" class="tool-btn" data-tool="ellipse" aria-pressed="false" title="Ellipse (O)">
                <span>Ellipse</span>
              </button>
              <button type="button" class="tool-btn" data-tool="text" aria-pressed="false" title="Text (T)">
                <span>Text</span>
              </button>
              <button type="button" class="tool-btn" data-tool="select" aria-pressed="false" title="Select (V)">
                <span>Select</span>
              </button>
            </div>
            <div class="tool-group size-group">
              <label for="brushSize">Size</label>
              <input id="brushSize" type="range" min="1" max="30" value="4" step="1">
              <span id="brushSizeValue">4px</span>
            </div>
            <div class="tool-group colors" aria-label="Color picker">
              <button type="button" class="color-swatch active" data-color="#111111" title="Ink Black" style="--swatch:#111111"></button>
              <button type="button" class="color-swatch" data-color="#0a9663" title="Emerald" style="--swatch:#0a9663"></button>
              <button type="button" class="color-swatch" data-color="#e74c3c" title="Coral" style="--swatch:#e74c3c"></button>
              <button type="button" class="color-swatch" data-color="#f1c40f" title="Sun" style="--swatch:#f1c40f"></button>
              <button type="button" class="color-swatch" data-color="#2980b9" title="Ocean" style="--swatch:#2980b9"></button>
              <input type="color" id="customColor" title="Custom color" value="#111111">
            </div>
            <div class="tool-group tail">
              <button type="button" id="undoBtn" title="Undo (Ctrl+Z)">Undo</button>
              <button type="button" id="redoBtn" title="Redo (Ctrl+Y)">Redo</button>
              <button type="button" id="clearBoard" class="danger" title="Clear board">Clear</button>
            </div>
          </div>
          <div class="inline-wb-canvas">
            <canvas id="whiteboardCanvas" aria-label="Collaborative whiteboard" role="img"></canvas>
            <canvas id="whiteboardOverlay" aria-hidden="true"></canvas>
            <div id="textInputWrapper">
              <input id="wbTextInput" type="text" placeholder="Type and press Enter">
            </div>
          </div>
        </div>
        
      </div>
    </section>

    <div class="resizer resizer-right" id="resizerRight" title="Drag to resize"></div>
    <aside class="panel panel-right" id="panelRight">
      <div class="collapse-handle" id="collapseRight" title="Collapse">‚ñ∂</div>
      <div class="panel-header">
        <span>Collaboration</span>
        <div id="toolbarRoomDisplay" style="margin-left:6px;color:#cfefe0;font-size:10px;white-space:nowrap;"> ROOM ID: <span id="toolbarRoomId">loading...</span></div>
      </div>
      <div class="collapsed-icons" data-panel="right" aria-hidden="true">
        <button type="button" class="collapsed-icon" title="Live Audio">
          <span aria-hidden="true">üéôÔ∏è</span>
        </button>
        <button type="button" class="collapsed-icon" title="Input / Output">
          <span aria-hidden="true">‚å®Ô∏è</span>
        </button>
        <button type="button" class="collapsed-icon" title="Users">
          <span aria-hidden="true">üë•</span>
        </button>
      </div>
      <div class="collab-card voice-card">
        <div class="card-title">Live Audio</div>
        <div class="voice-box" style="margin-top:8px;border:1px dashed #0a5;padding:10px;border-radius:10px;display:flex;flex-direction:column;gap:8px;">
          <div class="voice-controls" style="display:flex;gap:8px;">
            <button id="voiceJoinBtn" type="button" title="Join Voice" aria-label="Join voice" style="background:#0a5;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;"><i class="fa-solid fa-user-plus"></i></button>
            <button id="voiceMicToggleBtn" type="button" title="Toggle Mic" aria-label="Toggle microphone" style="background:transparent;color:#fff;border:1px solid #ffffff22;padding:6px 10px;border-radius:6px;cursor:pointer;"><i class="fa-solid fa-microphone"></i></button>
            <button id="voiceLeaveBtn" type="button" title="Leave Voice" aria-label="Leave voice" style="background:transparent;color:#fff;border:1px solid #ffffff22;padding:6px 10px;border-radius:6px;cursor:pointer;"><i class="fa-solid fa-right-from-bracket"></i></button>
          </div>
          <div id="voiceAudios" class="voice-audios" aria-live="polite" style="position:relative;width:100%;height:0;overflow:visible;"></div>
        </div>
      </div>
      <div class="collab-card share-card">
        <div class="share-card-head">
          <div>
            <div class="card-title">Share Room</div>
            <p class="share-card-desc">Copy the invite link for this room.</p>
          </div>
          <button id="shareRoomButton" type="button" class="share-room-btn" aria-live="polite">
            <span class="share-room-btn-label" data-default="Copy Link" data-success="Copied!">Copy Link</span>
          </button>
        </div>
        <div class="share-link-row">
          <input id="shareRoomLink" type="text" readonly value="Generating link..." aria-label="Room invite link">
          <button id="shareRoomIconBtn" type="button" class="share-room-icon" title="Copy invite link" aria-label="Copy invite link">
            <i class="fa-regular fa-copy"></i>
          </button>
        </div>
        <p class="share-room-hint">People with this link can join instantly.</p>
      </div>

      <div class="collab-card users-card">
        <div class="card-title">In Room</div>
        <div class="users-joined">
          <div id="usersList"></div>
        </div>
      </div>
    </aside>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.47.0/min/vs/loader.min.js"></script>
  <script src="ai-inline.js"></script>
  <script src="script.js"></script>
  <script src="whiteboard.js"></script>
  <script src="audioChat.js"></script>
  <script src="ui.js"></script>
  <script src="panel-resize.js"></script>
  <script>
    // Mobile bottom nav markup appended dynamically for better ordering
    (function(){
      const mobileNav = document.createElement('nav');
      mobileNav.id = 'mobileBottomNav';
      mobileNav.className = 'mobile-bottom-nav';
      mobileNav.innerHTML = `
        <button class="mobile-nav-btn" data-target="panelLeft" title="Files">
          <span class="nav-icon">üìÇ</span>
          <span class="nav-label">Files</span>
        </button>
        <button class="mobile-nav-btn" data-target="panelCenter" title="Editor">
          <span class="nav-icon">‚úèÔ∏è</span>
          <span class="nav-label">Editor</span>
        </button>
        <button class="mobile-nav-btn" data-target="output" title="Output">
          <span class="nav-icon">üñ•Ô∏è</span>
          <span class="nav-label">Output</span>
        </button>
        <button class="mobile-nav-btn" data-target="users" title="Users">
          <span class="nav-icon">üë•</span>
          <span class="nav-label">Users</span>
        </button>
        <button class="mobile-nav-btn" data-target="voice" title="Whiteboard">
          <span class="nav-icon">üé®</span>
          <span class="nav-label">Whiteboard</span>
        </button>
      `;
      document.body.appendChild(mobileNav);
      // basic click handling: delegate to panel-resize handlers if present
      mobileNav.addEventListener('click', function(e){
        const btn = e.target.closest('button');
        if(!btn) return;
        const target = btn.dataset.target;
        // dispatch a custom event used by panel-resize.js
        window.dispatchEvent(new CustomEvent('mobile-nav-select', { detail: { target }}));
      });
      // ensure an initial active state (editor) after nav is inserted
      setTimeout(() => {
        const initial = mobileNav.querySelector('button[data-target="panelCenter"]');
        if(initial) {
          initial.classList.add('active');
        }
        window.dispatchEvent(new CustomEvent('mobile-nav-select', { detail: { target: 'panelCenter' } }));
      }, 120);
    })();
  </script>
</body>
</html>